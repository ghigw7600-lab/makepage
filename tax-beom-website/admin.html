<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì„¸ë¬´íšŒê³„ ë²” - ê´€ë¦¬ì í˜ì´ì§€</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Noto Sans KR', -apple-system, sans-serif;
      background: #f5f5f5;
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      padding: 30px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 2px solid #4a8c3b;
    }

    h1 {
      color: #1a1a1a;
      font-size: 28px;
    }

    .stats {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: linear-gradient(135deg, #4a8c3b 0%, #5a9c4b 100%);
      color: white;
      padding: 20px;
      border-radius: 8px;
      text-align: center;
    }

    .stat-value {
      font-size: 32px;
      font-weight: 700;
      margin-bottom: 5px;
    }

    .stat-label {
      font-size: 14px;
      opacity: 0.9;
    }

    .filters {
      display: flex;
      gap: 15px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .filter-group {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .filter-group label {
      font-weight: 600;
      color: #52525B;
    }

    select, input {
      padding: 8px 12px;
      border: 1px solid #e5e5e5;
      border-radius: 6px;
      font-size: 14px;
    }

    .btn {
      padding: 8px 16px;
      background: #4a8c3b;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
    }

    .btn:hover {
      background: #3a7c2b;
    }

    .btn-danger {
      background: #dc2626;
    }

    .btn-danger:hover {
      background: #b91c1c;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }

    thead {
      background: #f9fafb;
    }

    th {
      padding: 12px;
      text-align: left;
      font-weight: 600;
      color: #1a1a1a;
      border-bottom: 2px solid #e5e5e5;
    }

    td {
      padding: 12px;
      border-bottom: 1px solid #f0f0f0;
      color: #52525B;
    }

    tbody tr:hover {
      background: #f9fafb;
    }

    .badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }

    .badge-bookkeeping { background: #dbeafe; color: #1e40af; }
    .badge-tax { background: #e0e7ff; color: #4338ca; }
    .badge-consulting { background: #fce7f3; color: #be185d; }
    .badge-refund { background: #d1fae5; color: #065f46; }
    .badge-property { background: #fef3c7; color: #92400e; }
    .badge-other { background: #e5e5e5; color: #52525B; }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #9ca3af;
    }

    .empty-state-icon {
      font-size: 64px;
      margin-bottom: 16px;
    }

    .action-buttons {
      display: flex;
      gap: 8px;
    }

    .btn-sm {
      padding: 4px 8px;
      font-size: 12px;
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: white;
      border-radius: 12px;
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      padding: 30px;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .modal-close {
      font-size: 28px;
      background: none;
      border: none;
      cursor: pointer;
      color: #9ca3af;
    }

    .detail-row {
      display: grid;
      grid-template-columns: 140px 1fr;
      gap: 12px;
      padding: 12px 0;
      border-bottom: 1px solid #f0f0f0;
    }

    .detail-label {
      font-weight: 600;
      color: #1a1a1a;
    }

    .detail-value {
      color: #52525B;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ“Š ì„¸ë¬´íšŒê³„ ë²” - ìƒë‹´ ì‹ ì²­ ê´€ë¦¬</h1>
      <button class="btn btn-danger" onclick="clearAllData()">ì „ì²´ ë°ì´í„° ì‚­ì œ</button>
    </div>

    <div class="stats">
      <div class="stat-card">
        <div class="stat-value" id="totalCount">0</div>
        <div class="stat-label">ì´ ì‹ ì²­ ê±´ìˆ˜</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="todayCount">0</div>
        <div class="stat-label">ì˜¤ëŠ˜ ì‹ ì²­</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="weekCount">0</div>
        <div class="stat-label">ì´ë²ˆ ì£¼ ì‹ ì²­</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="monthCount">0</div>
        <div class="stat-label">ì´ë²ˆ ë‹¬ ì‹ ì²­</div>
      </div>
    </div>

    <div class="filters">
      <div class="filter-group">
        <label>ìƒë‹´ ìœ í˜•:</label>
        <select id="filterType" onchange="filterData()">
          <option value="">ì „ì²´</option>
          <option value="bookkeeping">ì„¸ë¬´ê¸°ì¥</option>
          <option value="tax">ë²•ì¸ì„¸/ì¢…ì†Œì„¸ ì‹ ê³ </option>
          <option value="consulting">ì ˆì„¸ ì»¨ì„¤íŒ…</option>
          <option value="refund">ê²½ì •ì²­êµ¬</option>
          <option value="property">ì–‘ë„/ìƒì†/ì¦ì—¬</option>
          <option value="other">ê¸°íƒ€</option>
        </select>
      </div>
      <div class="filter-group">
        <label>ì‚¬ì—…ì ìœ í˜•:</label>
        <select id="filterBusiness" onchange="filterData()">
          <option value="">ì „ì²´</option>
          <option value="corporate">ë²•ì¸ì‚¬ì—…ì</option>
          <option value="individual">ê°œì¸ì‚¬ì—…ì</option>
          <option value="startup">ì˜ˆë¹„ì°½ì—…ì</option>
          <option value="freelancer">í”„ë¦¬ëœì„œ</option>
        </select>
      </div>
      <div class="filter-group">
        <label>ê²€ìƒ‰:</label>
        <input type="text" id="searchInput" placeholder="ì—°ë½ì²˜, ì´ë©”ì¼ ê²€ìƒ‰" oninput="filterData()">
      </div>
      <button class="btn" onclick="loadData()">ìƒˆë¡œê³ ì¹¨</button>
    </div>

    <table id="dataTable">
      <thead>
        <tr>
          <th>ì‹ ì²­ì¼ì‹œ</th>
          <th>ìƒë‹´ ìœ í˜•</th>
          <th>ì‚¬ì—…ì ìœ í˜•</th>
          <th>ì—°ë½ì²˜</th>
          <th>ì´ë©”ì¼</th>
          <th>ì•¡ì…˜</th>
        </tr>
      </thead>
      <tbody id="tableBody">
      </tbody>
    </table>

    <div id="emptyState" class="empty-state" style="display: none;">
      <div class="empty-state-icon">ğŸ“­</div>
      <h3>ìƒë‹´ ì‹ ì²­ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</h3>
      <p>ê³ ê°ì´ ìƒë‹´ ì‹ ì²­ì„ í•˜ë©´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</p>
    </div>
  </div>

  <!-- Detail Modal -->
  <div class="modal" id="detailModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>ìƒë‹´ ì‹ ì²­ ìƒì„¸</h2>
        <button class="modal-close" onclick="closeDetailModal()">Ã—</button>
      </div>
      <div id="detailContent"></div>
    </div>
  </div>

  <script>
    let allData = [];

    const consultTypeLabels = {
      bookkeeping: 'ì„¸ë¬´ê¸°ì¥',
      tax: 'ë²•ì¸ì„¸/ì¢…ì†Œì„¸ ì‹ ê³ ',
      consulting: 'ì ˆì„¸ ì»¨ì„¤íŒ…',
      refund: 'ê²½ì •ì²­êµ¬',
      property: 'ì–‘ë„/ìƒì†/ì¦ì—¬',
      other: 'ê¸°íƒ€'
    };

    const businessTypeLabels = {
      corporate: 'ë²•ì¸ì‚¬ì—…ì',
      individual: 'ê°œì¸ì‚¬ì—…ì',
      startup: 'ì˜ˆë¹„ì°½ì—…ì',
      freelancer: 'í”„ë¦¬ëœì„œ'
    };

    function loadFromLocalStorage() {
      const data = localStorage.getItem('taxBeomDB');
      allData = data ? JSON.parse(data) : [];
      allData.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
      updateStats();
      filterData();
    }

    function loadData() {
      const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbz8w3wne5oeiu1NaSrm0qfKX2vlM-Ea8lzZ6y0hEzJHp-UYTND9PGCoJ7KN8e26bwz9zA/exec';

      console.log('[Admin] Google Sheetsì—ì„œ ë°ì´í„° ë¡œë“œ ì‹œì‘...');

      // Google Sheetsì—ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
      fetch(GOOGLE_SCRIPT_URL)
        .then(response => response.json())
        .then(result => {
          if (result.success) {
            console.log('[Admin] Google Sheets ë°ì´í„° ë¡œë“œ ì„±ê³µ:', result.data.length + 'ê±´');
            allData = result.data;
            allData.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            updateStats();
            filterData();
          } else {
            console.error('[Admin] Google Sheets ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', result.error);
            // ì‹¤íŒ¨ ì‹œ LocalStorage ë°±ì—… ì‚¬ìš©
            console.log('[Admin] LocalStorage ë°±ì—… ë°ì´í„° ì‚¬ìš©');
            loadFromLocalStorage();
          }
        })
        .catch(error => {
          console.error('[Admin] ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜:', error);
          // ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ì‹œ LocalStorage ë°±ì—… ì‚¬ìš©
          console.log('[Admin] LocalStorage ë°±ì—… ë°ì´í„° ì‚¬ìš©');
          loadFromLocalStorage();
        });
    }

    function updateStats() {
      const total = allData.length;
      const now = new Date();
      const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
      const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);

      const todayCount = allData.filter(d => new Date(d.timestamp) >= today).length;
      const weekCount = allData.filter(d => new Date(d.timestamp) >= weekAgo).length;
      const monthCount = allData.filter(d => new Date(d.timestamp) >= monthStart).length;

      document.getElementById('totalCount').textContent = total;
      document.getElementById('todayCount').textContent = todayCount;
      document.getElementById('weekCount').textContent = weekCount;
      document.getElementById('monthCount').textContent = monthCount;
    }

    function filterData() {
      const typeFilter = document.getElementById('filterType').value;
      const businessFilter = document.getElementById('filterBusiness').value;
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();

      let filtered = allData;

      if (typeFilter) {
        filtered = filtered.filter(d => d.consultType === typeFilter);
      }
      if (businessFilter) {
        filtered = filtered.filter(d => d.businessType === businessFilter);
      }
      if (searchTerm) {
        filtered = filtered.filter(d =>
          (d.phone && d.phone.toLowerCase().includes(searchTerm)) ||
          (d.email && d.email.toLowerCase().includes(searchTerm))
        );
      }

      renderTable(filtered);
    }

    function renderTable(data) {
      const tbody = document.getElementById('tableBody');
      const emptyState = document.getElementById('emptyState');

      if (data.length === 0) {
        tbody.innerHTML = '';
        emptyState.style.display = 'block';
        return;
      }

      emptyState.style.display = 'none';

      tbody.innerHTML = data.map(item => `
        <tr>
          <td>${formatDate(item.timestamp)}</td>
          <td><span class="badge badge-${item.consultType}">${consultTypeLabels[item.consultType]}</span></td>
          <td>${businessTypeLabels[item.businessType] || '-'}</td>
          <td>${item.phone || '-'}</td>
          <td>${item.email || '-'}</td>
          <td class="action-buttons">
            <button class="btn btn-sm" onclick="viewDetail(${item.id})">ìƒì„¸ë³´ê¸°</button>
            <button class="btn btn-sm btn-danger" onclick="deleteItem(${item.id})">ì‚­ì œ</button>
          </td>
        </tr>
      `).join('');
    }

    function formatDate(timestamp) {
      const date = new Date(timestamp);
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      const hours = String(date.getHours()).padStart(2, '0');
      const minutes = String(date.getMinutes()).padStart(2, '0');
      return `${year}-${month}-${day} ${hours}:${minutes}`;
    }

    function viewDetail(id) {
      const item = allData.find(d => d.id === id);
      if (!item) return;

      const detailContent = document.getElementById('detailContent');
      detailContent.innerHTML = `
        <div class="detail-row">
          <div class="detail-label">ì‹ ì²­ì¼ì‹œ</div>
          <div class="detail-value">${formatDate(item.timestamp)}</div>
        </div>
        <div class="detail-row">
          <div class="detail-label">ìƒë‹´ ìœ í˜•</div>
          <div class="detail-value"><span class="badge badge-${item.consultType}">${consultTypeLabels[item.consultType]}</span></div>
        </div>
        <div class="detail-row">
          <div class="detail-label">ì‚¬ì—…ì ìœ í˜•</div>
          <div class="detail-value">${businessTypeLabels[item.businessType]}</div>
        </div>
        <div class="detail-row">
          <div class="detail-label">ì‚¬ì—…ìë“±ë¡ë²ˆí˜¸</div>
          <div class="detail-value">${item.businessNumber || '-'}</div>
        </div>
        <div class="detail-row">
          <div class="detail-label">ì—°ë½ì²˜</div>
          <div class="detail-value"><a href="tel:${item.phone}">${item.phone}</a></div>
        </div>
        <div class="detail-row">
          <div class="detail-label">ì´ë©”ì¼</div>
          <div class="detail-value">${item.email ? `<a href="mailto:${item.email}">${item.email}</a>` : '-'}</div>
        </div>
        <div class="detail-row">
          <div class="detail-label">ìƒë‹´ ë‚´ìš©</div>
          <div class="detail-value">${item.content || '-'}</div>
        </div>
        <div class="detail-row">
          <div class="detail-label">ë§ˆì¼€íŒ… ìˆ˜ì‹ ë™ì˜</div>
          <div class="detail-value">${item.agreeMarketing === 'on' ? 'ë™ì˜' : 'ë¯¸ë™ì˜'}</div>
        </div>
      `;

      document.getElementById('detailModal').classList.add('active');
    }

    function closeDetailModal() {
      document.getElementById('detailModal').classList.remove('active');
    }

    function deleteItem(id) {
      if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

      allData = allData.filter(d => d.id !== id);
      localStorage.setItem('taxBeomDB', JSON.stringify(allData));
      loadData();
      alert('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
    }

    function clearAllData() {
      if (!confirm('ì „ì²´ ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) return;

      localStorage.removeItem('taxBeomDB');
      allData = [];
      loadData();
      alert('ì „ì²´ ë°ì´í„°ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
    }

    // ì´ˆê¸° ë¡œë“œ
    loadData();

    // 5ì´ˆë§ˆë‹¤ ìë™ ìƒˆë¡œê³ ì¹¨
    setInterval(loadData, 5000);
  </script>
</body>
</html>
